# Medication Mapping

## XML HL7 > JSON FHIR

A GP Connect FHIR `Medication` is mapped from an GP2GP HL7v3 `MedicationStatement`.

| Mapped to (JSON FHIR Encounter field) | Mapped from (XML HL7 / other source)                                                                                                                                                                                                       |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| id                                    | Generated by the adaptor (not linked to the MedicationStatement).                                                                                                                                                                          |
| meta.profile\[0]                      | fixed value = `"https://fhir.nhs.uk/STU3/StructureDefinition/CareConnect-GPC-Medication-1"`                                                                                                                                                |
| code.coding\[0].system                | fixed value = `http://snomed.info/sct`                                                                                                                                                                                                     |
| code.coding\[0].code                  | `MedicationStatement / consumable / manufacturedProduct / manufacturedMaterial / code [@code]`.<br/>If the code is not a SNOMED code then the adaptor will insert code = 196421000000109 and display = Transfer-degraded medication entry. |
| code.coding\[0].display               | `MedicationStatement / consumable / manufacturedProduct / manufacturedMaterial / code [@displayName]`                                                                                                                                      |

<details>
    <summary>Example JSON</summary>

```
            "resource": {
                "resourceType": "Medication",
                "id": "4c6a99eb-fabb-4e92-809c-b738dc9a114d",
                "meta": {
                    "profile": [
                        "https://fhir.nhs.uk/STU3/StructureDefinition/CareConnect-GPC-Medication-1"
                    ]
                },
                "code": {
                    "coding": [
                        {
                            "system": "http://snomed.info/sct",
                            "code": "178011000001104",
                            "display": "Zimovane LS 3.75mg tablets (Sanofi)"
                        }
                    ]
                }

```
</details>

- If a SNOMED CT code cannot be found `code.coding[0]` will not be populated. The adaptor will insert code = 196421000000109 and display = Transfer-degraded medication entry.

### Unmapped fields

`Medication` is a subset of mappings from `MedicationStatement` in the XML and as such doesn't include every field, see here for details:
[https://developer.nhs.uk/apis/gpconnect-1-6-0/accessrecord_structured_development_medication.html](https://developer.nhs.uk/apis/gpconnect-1-6-0/accessrecord_structured_development_medication.html)

## JSON FHIR > XML HL7
A GP2GP HL7v3 `MedicationStatement`is mapped from a GP Connect FHIR `Medication`.

| Mapped to (XML HL7 MedicationStatement)                                                  | Mapped from (JSON FHIR / other source )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| id \[@root]                                                                              | A random UUID generated by the Adaptor                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| statusCode \[@code]                                                                      | Mapped from `MedicationRequest.status` - either `ACTIVE` or `COMPLETE`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| effectiveTime                                                                            | Mapped from `MedicationRequest.dispenseRequest.validityPeriod` - will either have Start (low)  & End (high) or only Start                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| availabilityTime \[@value]                                                               | Mapped from `MedicationRequest.dispenseRequest.validityPeriod.start`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                   |
| consumable / manufacturedProduct / manufacturedMaterial \[@determinerCode]               | fixed value = `KIND`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| consumable / manufacturedProduct / manufacturedMaterial / code \[@code]                  | `Medication.code.coding[0].code`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| consumable / manufacturedProduct / manufacturedMaterial / code \[@codeSystem]            | fixed value =`"2.16.840.1.113883.2.1.3.2.4.15"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| consumable / manufacturedProduct / manufacturedMaterial / code \[@displayName]           | Mapped from `descriptionDisplay` value inside the extension within the `CodableConcept` if present.<br/>If not present then mapped from the `display` value inside the `CodableConcept`                                                                                                                                                                                                                                                                                                                                                                                      |
| consumable / manufacturedProduct / manufacturedMaterial / code / originalText            | Mapped from `MedicationRequest.dispenseRequest.quantity.unit`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| component / ehrSupplyPrescribe / id \[@root]                                             | `MedicationRequest.id`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | 
| component / ehrSupplyPrescribe / code \[@code]                                           | Only mapped when `MedicationStatement.extension[index]` where `extension[index].url.value` equals `https://fhir.nhs.uk/STU3/StructureDefinition/Extension-CareConnect-GPC-PrescribingAgency-1` <br/> 1. If `MedicationStatement.extension[0].valueCodeableConcept.coding[0].code` is `"prescribed-at-gp-practice"` OR `"prescribed-by-previous-practice"` then value is `394823007`.<br/>2. If `MedicationStatement.extension[0].valueCodeableConcept.coding[0].code` is `"prescribed-by-another-organisation"` then value is `394828003`.                                   |
| component / ehrSupplyPrescribe / code \[@displayName]                                    | Only mapped when `MedicationStatement.extension[index]` where `extension[index].url.value` equals `https://fhir.nhs.uk/STU3/StructureDefinition/Extension-CareConnect-GPC-PrescribingAgency-1` <br/> 1. If `MedicationStatement.extension[0].valueCodeableConcept.coding[0].code` is `"prescribed-at-gp-practice"` OR `"prescribed-by-previous-practice"` then value is `NHS Prescription`.<br/>2. If `MedicationStatement.extension[0].valueCodeableConcept.coding[0].code` is `"prescribed-by-another-organisation"` then value is `Prescription by another organisation`. |
| component / ehrSupplyPrescribe / code \[@codeSystem]                                     | fixed value = `"2.16.840.1.113883.2.1.3.2.4.15"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| component / ehrSupplyPrescribe / statusCode \[@code]                                     | Mapped from `MedicationRequest.status` - either `ACTIVE` or `COMPLETE`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| component / ehrSupplyPrescribe / availabilityTime \[@value]                              | Mapped from `MedicationRequest.dispenseRequest.validityPeriod.start`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| component / ehrSupplyPrescribe / quantity \[@value]                                      | If present then: `MedicationRequest.dispenseRequest.quantity.value` otherwise defaults to `"1"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| component / ehrSupplyPrescribe / quantity \[@unit]                                       | If present then: `MedicationRequest.dispenseRequest.quantity.unit`.<br/>Otherwise if present then: `MedicationRequest.dispenseRequest.extension`.<br/>Otherwise if present then: `MedicationRequest.dispenseRequest.quantity.extension`.<br/>If none present then default value is `"Unk UoM"` (unknown unit of measurement).                                                                                                                                                                                                                                                |
| component / ehrSupplyPrescribe / quantity / translation \[@value]                        | If present then: `MedicationRequest.dispenseRequest.quantity.value` otherwise defaults to `"1"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| component / ehrSupplyPrescribe / quantity / translation / originalText                   | If present then: `MedicationRequest.dispenseRequest.quantity.value`.<br/>Otherwise if present then: `MedicationRequest.dispenseRequest.extension`.<br/>Otherwise if present then: `MedicationRequest.dispenseRequest.quantity.extension`.<br/>If none present then default value is `"Unk UoM"` (unknown unit of measurement).                                                                                                                                                                                                                                               |
| component / ehrSupplyPrescribe / inFulfillmentOf / priorMedicationRef \[@moodCode]       | fixed value = `"INT"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| component / ehrSupplyPrescribe / inFulfillmentOf / priorMedicationRef / id \[@root]      | Built from `MedicationRequest.id`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| component / ehrSupplyPrescribe / pertinentInformation \[@typeCode]                       | fixed value = `PERT`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| component / ehrSupplyPrescribe / pertinentInformation / pertinentSupplyAnnotation / text | Only contains the present values and separated by whitespace (`" "`) - built from:<br/> -`MedicationRequest.note[0].text`.<br/> -`MedicationRequest.dosageInstruction[0].text`<br/> - `MedicationRequest.dispenseRequest.expectedSupplyDuration`                                                                                                                                                                                                                                                                                                                             |
| pertinentInformation \[@typeCode]                                                        | fixed value = `PERT`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| pertinentInformation / pertinentMedicationDosage \[@classCode]                           | fixed value = `SBADM`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| pertinentInformation / pertinentMedicationDosage \[@moodCode]                            | fixed value = `RMD`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| pertinentInformation / pertinentMedicationDosage / text                                  | Built from `MedicationRequest.dosageInstruction[0].text`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| participant \[@typeCode]                                                                 | fixed value = `AUT`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| participant \[@contextControlCode]                                                       | fixed value = `OP`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| participant / agentRef \[@classCode]                                                     | fixed value = `AGNT`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| participant / agentRef / id \[@root]                                                     | If resourceType is `"practitioner"` OR `"practitionerRole"` build from `"practitioner.reference"`<br/> If resourceType is `"Organization"` then build from `"organization.reference"`                                                                                                                                                                                                                                                                                                                                                                                        |


<details>
    <summary>Example XML</summary>

```
<MedicationStatement classCode="SBADM" moodCode="ORD">
   <id root="0FC9E511-9CCA-42DD-986A-D58ABD8208C8"/>
   <statusCode code="COMPLETE"/>
   <effectiveTime>
      <low value="20130103"/><high value="20130602"/>
   </effectiveTime>
   <availabilityTime value="20130103"/>
   <consumable typeCode="CSM">
      <manufacturedProduct classCode="MANU">
         <manufacturedMaterial determinerCode="KIND" classCode="MMAT">
            <code code="178011000001104" codeSystem="2.16.840.1.113883.2.1.3.2.4.15" displayName="Zimovane LS 3.75mg tablets (Sanofi)">
              </code>
         </manufacturedMaterial>
      </manufacturedProduct>
   </consumable>
   <component typeCode="COMP">
      <ehrSupplyPrescribe>
         <id root="61B8E9FD-552A-42A1-8562-208B612C429B"/>
         <code code="394823007" displayName="NHS Prescription" codeSystem="2.16.840.1.113883.2.1.3.2.4.15"/>
         <statusCode code="COMPLETE"/>
         <availabilityTime value="20130103"/>
         <quantity value="150" unit="1">
            <translation value="150">
               <originalText>tablet</originalText>
            </translation>
         </quantity>
         <inFulfillmentOf typeCode="FLFS">
            <priorMedicationRef moodCode="INT">
               <id root="E41C267A-D303-4A13-8F50-C93A1543A279"/>
            </priorMedicationRef>
         </inFulfillmentOf>
         <pertinentInformation typeCode="PERT">
            <pertinentSupplyAnnotation>
               <text>Expected Supply Duration: 150 day</text>
            </pertinentSupplyAnnotation>
         </pertinentInformation>
      </ehrSupplyPrescribe>
   </component>
   <pertinentInformation typeCode="PERT">
      <pertinentMedicationDosage classCode="SBADM" moodCode="RMD">
         <text>One To Be Taken At Night</text>
      </pertinentMedicationDosage>
   </pertinentInformation>
   <Participant typeCode="AUT" contextControlCode="OP">
      <agentRef classCode="AGNT">
         <id root="2D70F602-6BB1-47E0-B2EC-39912A59787D"/>
      </agentRef>
   </Participant>
</MedicationStatement>
```
</details>

## Further documentation

[GP Connect Medication](https://developer.nhs.uk/apis/gpconnect-1-6-0/accessrecord_structured_development_medication.html)

[MIM 4.2.00](https://data.developer.nhs.uk/dms/mim/4.2.00/Index.htm)