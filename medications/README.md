# Medication Mapping

## XML HL7 > JSON FHIR

A GP Connect FHIR `Medication` is mapped from an GP2GP HL7v3 `MedicationStatement`.

| Mapped to (JSON FHIR Encounter field) | Mapped from (XML HL7 / other source)                                                                  |
|---------------------------------------|-------------------------------------------------------------------------------------------------------|
| id                                    | Generated by the adaptor (not linked to the MedicationStatement).                                     |
| meta.profile\[0]                      | fixed value = `"https://fhir.nhs.uk/STU3/StructureDefinition/CareConnect-GPC-Encounter-1"`            |
| code.coding\[0].system                | fixed value = `http://snomed.info/sct`                                                                |
| code.coding\[0].code                  | `MedicationStatement / consumable / manufacturedProduct / manufacturedMaterial / code [@code]`        |
| code.coding\[0].display               | `MedicationStatement / consumable / manufacturedProduct / manufacturedMaterial / code [@displayName]` |

<details>
    <summary>Example JSON</summary>

```
            "resource": {
                "resourceType": "Medication",
                "id": "4c6a99eb-fabb-4e92-809c-b738dc9a114d",
                "meta": {
                    "profile": [
                        "https://fhir.nhs.uk/STU3/StructureDefinition/CareConnect-GPC-Medication-1"
                    ]
                },
                "code": {
                    "coding": [
                        {
                            "system": "http://snomed.info/sct",
                            "code": "178011000001104",
                            "display": "Zimovane LS 3.75mg tablets (Sanofi)"
                        }
                    ]
                }

```
</details>

- If a SNOMED CT code cannot be found `code.coding[0]` will not be populated.

### Unmapped fields

`Medication` is a subset of mappings from `MedicationStatement` in the XML and as such doesn't include every field, see here for details:
[https://developer.nhs.uk/apis/gpconnect-1-6-0/accessrecord_structured_development_medication.html](https://developer.nhs.uk/apis/gpconnect-1-6-0/accessrecord_structured_development_medication.html)

## JSON FHIR > XML HL7
A GP Connect FHIR `Medication` is mapped from an GP2GP HL7v3 `MedicationStatement`.

| Mapped to (XML HL7 ehrComposition child element)                               | Mapped from (JSON FHIR / other source )                                                                                                                                                                                                                                                                                                                                 |
|--------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| id \[@root]                                                                    | A random UUID generated by the Adaptor                                                                                                                                                                                                                                                                                                                                  |
| statusCode \[@code]                                                            | Mapped from `MedicationRequest.status` - either `ACTIVE` or `COMPLETE`                                                                                                                                                                                                                                                                                                  |
| effectiveTime                                                                  | `MedicationRequest.dispenseRequest.validityPeriod` - will either have Start (low)  & End (high) or only Start                                                                                                                                                                                                                                                           |
| availabilityTime \[@value]                                                     | `MedicationRequest.dispenseRequest.validityPeriod.start`                                                                                                                                                                                                                                                                                                                |
| consumable / manufacturedProduct / manufacturedMaterial / code \[@code]        | `Medication.code.coding[0].code`                                                                                                                                                                                                                                                                                                                                        |
| consumable / manufacturedProduct / manufacturedMaterial / code \[@codeSystem]  | fixed value =`"2.16.840.1.113883.2.1.3.2.4.15"`                                                                                                                                                                                                                                                                                                                         |
| consumable / manufacturedProduct / manufacturedMaterial / code \[@displayName] |                                                                                                                                                                                                                                                                                                                                                                         |
| consumable / manufacturedProduct / manufacturedMaterial / code / originalText  |                                                                                                                                                                                                                                                                                                                                                                         |
| component / ehrSupplyPrescribe / id \[@root]                                   | `MedicationRequest.id`                                                                                                                                                                                                                                                                                                                                                  | 
| component / ehrSupplyPrescribe / code \[@code]                                 | 1. If `MedicationStatement.extension[0].valueCodeableConcept.coding[0].code` is `"prescribed-at-gp-practice"` OR `"prescribed-by-previous-practice"` then value is `394823007`.<br/>2. If `MedicationStatement.extension[0].valueCodeableConcept.coding[0].code` is `"prescribed-by-another-organisation"` then value is `394828003`.                                   |
| component / ehrSupplyPrescribe / code \[@displayName]                          | 1. If `MedicationStatement.extension[0].valueCodeableConcept.coding[0].code` is `"prescribed-at-gp-practice"` OR `"prescribed-by-previous-practice"` then value is `NHS Prescription`.<br/>2. If `MedicationStatement.extension[0].valueCodeableConcept.coding[0].code` is `"prescribed-by-another-organisation"` then value is `Prescription by another organisation`. |
| component / ehrSupplyPrescribe / code \[@codeSystem]                           | fixed value = `"2.16.840.1.113883.2.1.3.2.4.15"`                                                                                                                                                                                                                                                                                                                        |
| component / ehrSupplyPrescribe / statusCode \[@code]                           | *****Mapped from `MedicationRequest.status` - either `ACTIVE` or `COMPLETE`                                                                                                                                                                                                                                                                                             |
| component / ehrSupplyPrescribe / availabilityTime \[@value]                    |                                                                                                                                                                                                                                                                                                                                                                         |
| Participant2 / AgentRef / id \[@root]                                          | `Encounter.participant[index].individual` where `Encounter.participant[index].type` contains a `coding.code` of `"PPRF"`                                                                                                                                                                                                                                                | 


<details>
    <summary>Example XML</summary>

```
<ehrComposition classCode=\"COMPOSITION\" moodCode=\"EVN\">
    <id root=\"4BBABD06-93E2-4E87-9345-9B1171AC576F\" />
    <code code=\"24591000000103\" displayName=\"Other report\" codeSystem=\"2.16.840.1.113883.2.1.3.2.4.15\">
        <originalText>Surgery Consultation</originalText>
    </code>
    <statusCode code=\"COMPLETE\" />
    <effectiveTime>
        <low value=\"20190328103000\"/><high value=\"20190328103800\"/>
    </effectiveTime>
    <availabilityTime value=\"20190328103000\"/>
    <author typeCode=\"AUT\" contextControlCode=\"OP\">
        <time value=\"20190328103000\" />
        <agentRef classCode=\"AGNT\">
            <id root=\"4ED3292E-EC9E-400D-84D2-758CCDEA40A4\" />
        </agentRef>
    </author>
    <location typeCode="LOC">
        <locatedEntity classCode="LOCE">
            <code code="394730007" codeSystem="2.16.840.1.113883.2.1.3.2.4.15" displayName="Healthcare related organisation" />
            <locatedPlace classCode="PLC" determinerCode="INSTANCE">
                <name>Example location</name>
            </locatedPlace>
        </locatedEntity>
    </location>
    <Participant2 typeCode=\"PRF\" contextControlCode=\"OP\">
        <agentRef classCode=\"AGNT\">
            <id root=\"4ED3292E-EC9E-400D-84D2-758CCDEA40A4\"/>
        </agentRef>
    </Participant2>
    <component typeCode=\"COMP\">

    ...

    </component>
</ehrComposition>
```
</details>

3. If the code is a SNOMED code within the [EHR Composition Name Vocabulary](https://data.developer.nhs.uk/dms/mim/6.3.01/Vocabulary/EhrCompositionName.htm)
   then that code and display name is used. Otherwise, the SNOMED code `24591000000103` and the display name `Other report` are inserted by the adaptor.
4. `Encounter.type[0].coding[0].display` is only used if the adaptor inserts `Other report`, as described in footnote 3.
5. Where the List is the consultation [List](../list/README.md) resource that references the Encounter.

## Further documentation

[GP Connect Encounter](https://developer.nhs.uk/apis/gpconnect-1-6-0/accessrecord_structured_development_encounter.html)

[MIM 4.2.00](https://data.developer.nhs.uk/dms/mim/4.2.00/Index.htm)

[EHR Composition Name Vocabulary](https://data.developer.nhs.uk/dms/mim/6.3.01/Vocabulary/EhrCompositionName.htm)
