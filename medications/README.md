# Medication Mapping

## XML HL7 > JSON FHIR

A GP Connect FHIR `Medication` is mapped from an GP2GP HL7v3 `MedicationStatement`.

| Mapped to (JSON FHIR Encounter field) | Mapped from (XML HL7 / other source)                                                                  |
|---------------------------------------|-------------------------------------------------------------------------------------------------------|
| id                                    | Generated by the adaptor (not linked to the MedicationStatement).                                     |
| meta.profile\[0]                      | fixed value = `"https://fhir.nhs.uk/STU3/StructureDefinition/CareConnect-GPC-Encounter-1"`            |
| code.coding\[0].system                | fixed value = `http://snomed.info/sct`                                                                |
| code.coding\[0].code                  | `MedicationStatement / consumable / manufacturedProduct / manufacturedMaterial / code [@code]`        |
| code.coding\[0].display               | `MedicationStatement / consumable / manufacturedProduct / manufacturedMaterial / code [@displayName]` |

<details>
    <summary>Example JSON</summary>

```
            "resource": {
                "resourceType": "Medication",
                "id": "4c6a99eb-fabb-4e92-809c-b738dc9a114d",
                "meta": {
                    "profile": [
                        "https://fhir.nhs.uk/STU3/StructureDefinition/CareConnect-GPC-Medication-1"
                    ]
                },
                "code": {
                    "coding": [
                        {
                            "system": "http://snomed.info/sct",
                            "code": "178011000001104",
                            "display": "Zimovane LS 3.75mg tablets (Sanofi)"
                        }
                    ]
                }

```
</details>

- If a SNOMED CT code cannot be found `code.coding[0]` will not be populated.

### Unmapped fields

`Medication` is a subset of mappings from `MedicationStatement` in the XML and as such doesn't include every field, see here for details:
[https://developer.nhs.uk/apis/gpconnect-1-6-0/accessrecord_structured_development_medication.html](https://developer.nhs.uk/apis/gpconnect-1-6-0/accessrecord_structured_development_medication.html)

## JSON FHIR > XML HL7
A GP Connect FHIR `Medication` is mapped from an GP2GP HL7v3 `MedicationStatement`.

| Mapped to (XML HL7 ehrComposition child element)                                         | Mapped from (JSON FHIR / other source )                                                                                                                                                                                                                                                                                                                                 |
|------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| id \[@root]                                                                              | A random UUID generated by the Adaptor                                                                                                                                                                                                                                                                                                                                  |
| statusCode \[@code]                                                                      | Mapped from `MedicationRequest.status` - either `ACTIVE` or `COMPLETE`                                                                                                                                                                                                                                                                                                  |
| effectiveTime                                                                            | `MedicationRequest.dispenseRequest.validityPeriod` - will either have Start (low)  & End (high) or only Start                                                                                                                                                                                                                                                           |
| availabilityTime \[@value]                                                               | `MedicationRequest.dispenseRequest.validityPeriod.start`                                                                                                                                                                                                                                                                                                                |
| consumable \[@typeCode]                                                                  | fixed value = `CSM`                                                                                                                                                                                                                                                                                                                                                     |
| consumable / manufacturedProduct \[@classCode]                                           | fixed value = `MANU`                                                                                                                                                                                                                                                                                                                                                    |
| consumable / manufacturedProduct / manufacturedMaterial \[@determinerCode]               | fixed value = `KIND`                                                                                                                                                                                                                                                                                                                                                    |
| consumable / manufacturedProduct / manufacturedMaterial \[@classCode]                    | fixed value = `MMAT`                                                                                                                                                                                                                                                                                                                                                    |
| consumable / manufacturedProduct / manufacturedMaterial / code \[@code]                  | `Medication.code.coding[0].code`                                                                                                                                                                                                                                                                                                                                        |
| consumable / manufacturedProduct / manufacturedMaterial / code \[@codeSystem]            | fixed value =`"2.16.840.1.113883.2.1.3.2.4.15"`                                                                                                                                                                                                                                                                                                                         |
| consumable / manufacturedProduct / manufacturedMaterial / code \[@displayName]           |                                                                                                                                                                                                                                                                                                                                                                         |
| consumable / manufacturedProduct / manufacturedMaterial / code / originalText            |                                                                                                                                                                                                                                                                                                                                                                         |
| component \[@typeCode]                                                                   | fixed value = `COMP`                                                                                                                                                                                                                                                                                                                                                    |
| component / ehrSupplyPrescribe / id \[@root]                                             | `MedicationRequest.id`                                                                                                                                                                                                                                                                                                                                                  | 
| component / ehrSupplyPrescribe / code \[@code]                                           | 1. If `MedicationStatement.extension[0].valueCodeableConcept.coding[0].code` is `"prescribed-at-gp-practice"` OR `"prescribed-by-previous-practice"` then value is `394823007`.<br/>2. If `MedicationStatement.extension[0].valueCodeableConcept.coding[0].code` is `"prescribed-by-another-organisation"` then value is `394828003`.                                   |
| component / ehrSupplyPrescribe / code \[@displayName]                                    | 1. If `MedicationStatement.extension[0].valueCodeableConcept.coding[0].code` is `"prescribed-at-gp-practice"` OR `"prescribed-by-previous-practice"` then value is `NHS Prescription`.<br/>2. If `MedicationStatement.extension[0].valueCodeableConcept.coding[0].code` is `"prescribed-by-another-organisation"` then value is `Prescription by another organisation`. |
| component / ehrSupplyPrescribe / code \[@codeSystem]                                     | fixed value = `"2.16.840.1.113883.2.1.3.2.4.15"`                                                                                                                                                                                                                                                                                                                        |
| component / ehrSupplyPrescribe / statusCode \[@code]                                     | *****Mapped from `MedicationRequest.status` - either `ACTIVE` or `COMPLETE`                                                                                                                                                                                                                                                                                             |
| component / ehrSupplyPrescribe / availabilityTime \[@value]                              |                                                                                                                                                                                                                                                                                                                                                                         |
| component / ehrSupplyPrescribe / quantity \[@value]                                      | If the following value is present then: `MedicationRequest.dispenseRequest.quantity.value` otherwise defaults to `"1"`                                                                                                                                                                                                                                                  |
| component / ehrSupplyPrescribe / quantity \[@unit]                                       | If the following value is present then: `MedicationRequest.dispenseRequest.quantity.value`.<br/>Otherwise if present then: `MedicationRequest.dispenseRequest.extension`.<br/>Otherwise if present then: `MedicationRequest.dispenseRequest.quantity.extension`.<br/>If none present then default value is `"Unk UoM"` (unknown unit of measurement).                   |
| component / ehrSupplyPrescribe / quantity / translation \[@value]                        |                                                                                                                                                                                                                                                                                                                                                                         |
| component / ehrSupplyPrescribe / quantity / translation / originalText                   |                                                                                                                                                                                                                                                                                                                                                                         |
| component / ehrSupplyPrescribe / inFulfillmentOf \[@typeCode]                            | fixed value = `"FLFS"`                                                                                                                                                                                                                                                                                                                                                  |
| component / ehrSupplyPrescribe / inFulfillmentOf / priorMedicationRef \[@moodCode]       | fixed value = `"INT"`                                                                                                                                                                                                                                                                                                                                                   |
| component / ehrSupplyPrescribe / inFulfillmentOf / priorMedicationRef / id \[@root]      | Built from `MedicationRequest.id` or if not present then new one generated                                                                                                                                                                                                                                                                                              |
| component / ehrSupplyPrescribe / pertinentInformation \[@typeCode]                       | fixed value = `PERT`                                                                                                                                                                                                                                                                                                                                                    |
| component / ehrSupplyPrescribe / pertinentInformation / pertinentSupplyAnnotation / text | Only contains the present values and separated by whitespace (`" "`) - built from:<br/> -`MedicationRequest.note[0].text`.<br/> -`MedicationRequest.dosageInstruction[0].text`<br/> - `MedicationRequest.dispenseRequest.expectedSupplyDuration`                                                                                                                        |
| pertinentInformation \[@typeCode]                                                        | fixed value = `PERT`                                                                                                                                                                                                                                                                                                                                                    |
| pertinentInformation / pertinentMedicationDosage \[@classCode]                           | fixed value = `SBADM`                                                                                                                                                                                                                                                                                                                                                   |
| pertinentInformation / pertinentMedicationDosage \[@moodCode]                            | fixed value = `RMD`                                                                                                                                                                                                                                                                                                                                                     |
| pertinentInformation / pertinentMedicationDosage / text                                  | Built from `MedicationRequest.dosageInstruction[0].text`                                                                                                                                                                                                                                                                                                                |
| participant \[@typeCode]                                                                 | fixed value = `AUT`                                                                                                                                                                                                                                                                                                                                                     |
| participant \[@contextControlCode]                                                       | fixed value = `OP`                                                                                                                                                                                                                                                                                                                                                      |
| participant / agentRef \[@classCode]                                                     | fixed value = `AGNT`                                                                                                                                                                                                                                                                                                                                                    |
| participant / agentRef / id \[@root]                                                     | If resourceType is `"practitioner"` OR `"practitionerRole"` build from `"practitioner.reference"`<br/> If resourceType is `"Organization"` then build from `"organization.reference"`                                                                                                                                                                                   |


<details>
    <summary>Example XML</summary>

```
<MedicationStatement classCode="SBADM" moodCode="ORD">
   <id root="0FC9E511-9CCA-42DD-986A-D58ABD8208C8"/>
   <statusCode code="COMPLETE"/>
   <effectiveTime>
      <low value="20130103"/><high value="20130602"/>
   </effectiveTime>
   <availabilityTime value="20130103"/>
   <consumable typeCode="CSM">
      <manufacturedProduct classCode="MANU">
         <manufacturedMaterial determinerCode="KIND" classCode="MMAT">
            <code code="178011000001104" codeSystem="2.16.840.1.113883.2.1.3.2.4.15" displayName="Zimovane LS 3.75mg tablets (Sanofi)">
              </code>
         </manufacturedMaterial>
      </manufacturedProduct>
   </consumable>
   <component typeCode="COMP">
      <ehrSupplyPrescribe>
         <id root="61B8E9FD-552A-42A1-8562-208B612C429B"/>
         <code code="394823007" displayName="NHS Prescription" codeSystem="2.16.840.1.113883.2.1.3.2.4.15"/>
         <statusCode code="COMPLETE"/>
         <availabilityTime value="20130103"/>
         <quantity value="150" unit="1">
            <translation value="150">
               <originalText>tablet</originalText>
            </translation>
         </quantity>
         <inFulfillmentOf typeCode="FLFS">
            <priorMedicationRef moodCode="INT">
               <id root="E41C267A-D303-4A13-8F50-C93A1543A279"/>
            </priorMedicationRef>
         </inFulfillmentOf>
         <pertinentInformation typeCode="PERT">
            <pertinentSupplyAnnotation>
               <text>Expected Supply Duration: 150 day</text>
            </pertinentSupplyAnnotation>
         </pertinentInformation>
      </ehrSupplyPrescribe>
   </component>
   <pertinentInformation typeCode="PERT">
      <pertinentMedicationDosage classCode="SBADM" moodCode="RMD">
         <text>One To Be Taken At Night</text>
      </pertinentMedicationDosage>
   </pertinentInformation>
   <Participant typeCode="AUT" contextControlCode="OP">
      <agentRef classCode="AGNT">
         <id root="2D70F602-6BB1-47E0-B2EC-39912A59787D"/>
      </agentRef>
   </Participant>
</MedicationStatement>
```
</details>

3. If the code is a SNOMED code within the [EHR Composition Name Vocabulary](https://data.developer.nhs.uk/dms/mim/6.3.01/Vocabulary/EhrCompositionName.htm)
   then that code and display name is used. Otherwise, the SNOMED code `24591000000103` and the display name `Other report` are inserted by the adaptor.
4. `Encounter.type[0].coding[0].display` is only used if the adaptor inserts `Other report`, as described in footnote 3.
5. Where the List is the consultation [List](../list/README.md) resource that references the Encounter.

## Further documentation

[GP Connect Encounter](https://developer.nhs.uk/apis/gpconnect-1-6-0/accessrecord_structured_development_encounter.html)

[MIM 4.2.00](https://data.developer.nhs.uk/dms/mim/4.2.00/Index.htm)

[EHR Composition Name Vocabulary](https://data.developer.nhs.uk/dms/mim/6.3.01/Vocabulary/EhrCompositionName.htm)
